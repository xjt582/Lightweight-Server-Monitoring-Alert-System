# è½»é‡çº§æœåŠ¡å™¨æ€§èƒ½ç›‘æ§çœ‹æ¿ï¼ˆè¸©å‘ç‰ˆï¼‰

è¿™ä¸ªç‰ˆæœ¬æ˜¯ç¬¬ä¸€æ¬¡æ“ä½œçš„æ—¶å€™å†™çš„ï¼Œæ²¡æœ‰åšä»»ä½•æ•´ç†ï¼Œé€»è¾‘æ¯”è¾ƒæ··ä¹±ã€‚

## ç¬¬ 1 å¤©ï¼šç¯å¢ƒåˆå§‹åŒ– & é¡¹ç›®éª¨æ¶

### ã€ä»»åŠ¡ã€‘

- åˆ›å»º VMware Linux è™šæ‹Ÿæœº

  ç°åœ¨æ˜¯åœ¨VMware17ä¸­å®‰è£…çš„ubuntu24.04

  é»˜è®¤å®‰è£…çš„å›¾å½¢åŒ–ç•Œé¢ï¼Œæœ¬æœºä¸­å¯ä»¥ä½¿ç”¨**`Ctrl + Alt + F6`**åˆ‡æ¢åˆ°å‘½ä»¤è¡Œæ¨¡å¼ï¼Œ**`Ctrl + Alt + F2`**è¿”å›å›¾å½¢ç•Œé¢

  ç°åœ¨æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯ï¼šç‰©ç†æœºå¤åˆ¶çš„å†…å®¹æ— æ³•ç²˜è´´åˆ°è™šæ‹Ÿæœºä¸­ï¼Œè™½ç„¶å¯ä»¥ä½¿ç”¨xshellæ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼Œå—é™äºç”µè„‘æ€§èƒ½è¿˜æ˜¯èƒ½å°‘å¼€ç‚¹è½¯ä»¶å°±å°‘å¼€ç‚¹ã€‚

  å…ˆåˆ‡æ¢åˆ°rootç”¨æˆ·:

  ```
  su - root
  ```

  éœ€è¦å®‰è£…toolså·¥å…·:

  ```
  apt-get install open-vm-tools -y
  apt-get install open-vm-tools-desktop -y
  ```

  æœ€åé‡å¯ä¸€ä¸‹

  ```
  reboot
  ```

  å½“ç„¶ï¼Œä¸ºäº†æ–¹ä¾¿è¿˜æ˜¯è¦å®‰è£…ä¸€ä¸‹sshæœåŠ¡ï¼Œæ¯•ç«ŸxshellçœŸçš„è¦å¥½ç”¨å¾ˆå¤šï¼Œå…·ä½“å¯ä»¥å‚è€ƒ

  https://blog.csdn.net/weixin_52852052/article/details/126131995?fromshare=blogdetail&sharetype=blogdetail&sharerId=126131995&sharerefer=PC&sharesource=m0_72360152&sharefrom=from_link

  å®é™…æ“ä½œä¸­ä¸centosä¸€ä¸ªå¾ˆå¤§çš„åŒºåˆ«å°±æ˜¯ï¼šUbuntuä¸èƒ½ç›´æ¥é€šè¿‡xshellé“¾æ¥rootç”¨æˆ·ï¼Œè§£å†³åŠæ³•å¯ä»¥å‚ç…§https://cloud.tencent.com/developer/article/1596471?shareByChannel=link

- å®‰è£… Pythonã€MySQLã€Git

- åˆå§‹åŒ–é¡¹ç›®ç›®å½•ä¸ Git ä»“åº“

### ã€è¦æ±‚ã€‘

- è™šæ‹Ÿæœºèƒ½æ­£å¸¸è”ç½‘

  ![image-20251216000942873](./images/image-20251216000942873.png)

  æ²¡æœ‰ä¸¢åŒ…ï¼Œç½‘ç»œæ­£å¸¸

- `python3 --version` æ­£å¸¸

  ![image-20251216001149870](./images/image-20251216001149870.png)

  python3å’Œpipéƒ½æ˜¯æ­£å¸¸çš„

  ![image-20251216001302182](./images/image-20251216001302182.png)

  æ•°æ®åº“ä¹Ÿåœ¨è¿è¡Œ

  ![image-20251216001346262](./images/image-20251216001346262.png)

  Gitä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„

- é¡¹ç›®ç›®å½•ç»“æ„æ¸…æ™°ï¼š

  ```
  monitor/
  â”œâ”€â”€ collector		ç›‘æ§æ•°æ®é‡‡é›†å±‚ï¼ˆAgentï¼‰
  â”œâ”€â”€ web		Web æœåŠ¡å±‚ï¼ˆå±•ç¤º + APIï¼‰
  â”œâ”€â”€ sql		æ•°æ®åº“ç»“æ„å±‚ï¼ˆåŸºç¡€è®¾æ–½ï¼‰
  â”œâ”€â”€ docs		é¡¹ç›®æ–‡æ¡£ï¼ˆå·¥ç¨‹ç´ å…»ï¼‰
  â””â”€â”€ screenshots		é¡¹ç›®æˆæœå±•ç¤º
  ```
  
  ![image-20251216001516172](./images/image-20251216001516172.png)
  
  ç›®å½•ç»“æ„æ— é—®é¢˜ï¼Œå‡†å¤‡ç¬¬äºŒå¤©çš„ä»»åŠ¡ã€‚æƒ³èµ·æ¥ä¸€ä¸ªå…³æœºå¿«æ·å‘½ä»¤ï¼š
  
  ```
  shutdown now
  ```
  
  ä»Šå¤©å®Œæˆäº†Ubuntu 24.04 è™šæ‹Ÿæœºä¸Šå®Œæˆäº†é¡¹ç›®è¿è¡Œç¯å¢ƒçš„åˆå§‹åŒ–ï¼ŒåŒ…æ‹¬ Pythonã€MySQLã€Git çš„éƒ¨ç½²ï¼Œå¹¶è§„åˆ’äº†ç›‘æ§é¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œä¸ºåç»­é‡‡é›†ã€å­˜å‚¨å’Œ Web å±•ç¤ºæ¨¡å—åšå‡†å¤‡

------

## ç¬¬ 2 å¤©ï¼šç³»ç»ŸæŒ‡æ ‡é‡‡é›†ï¼ˆpsutilï¼‰

### ã€ä»»åŠ¡ã€‘

- å®‰è£… psutil

  - å®‰è£…ç›´æ¥pipå®‰è£…æ—¶é‡åˆ°ä¸€ä¸ªé—®é¢˜   error: externally-managed-environment
  - è¿™æ˜¯ **Ubuntu 24.04 + Python 3.12 + PEP 668** çš„æ–°æœºåˆ¶ï¼š

    > **ç³»ç»Ÿ Python è¢« apt ç®¡ç†ï¼Œç¦æ­¢ pip ç›´æ¥å¾€ç³»ç»Ÿç¯å¢ƒè£…åŒ…**

    **åœ¨ Ubuntu 24.04 ä¸Šæ€ä¹ˆç®¡ç† Python ä¾èµ–ï¼Ÿ**

    **Ubuntu 24.04 é»˜è®¤å¯ç”¨äº† PEP 668ï¼Œåœ¨é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ Python è™šæ‹Ÿç¯å¢ƒéš”ç¦»ä¾èµ–ï¼Œé¿å…ç ´åç³»ç»Ÿ Pythonï¼Œè¿™ä¹Ÿæ˜¯ç”Ÿäº§ç¯å¢ƒä¸­æ¨èçš„åšæ³•ã€‚**

    è™šæ‹Ÿç¯å¢ƒçš„é…ç½®å¯ä»¥å‚è€ƒhttps://developer.aliyun.com/article/1597982

    åŒæ ·ï¼Œåç»­æ‰€æœ‰ Python æ“ä½œï¼Œéƒ½è¦å…ˆè¿›å…¥è™šæ‹Ÿç¯å¢ƒï¼š

    ```
    cd ~/monitor
    source venv/bin/activate
    ```
    
    ç”¨å®Œä¹‹åè‚¯å®šæ˜¯è¦é€€å‡ºè™šæ‹Ÿç¯å¢ƒçš„ï¼Œåªéœ€è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
    
    ```
    deactivate
    ```
    
    

- ç¼–å†™ Python è„šæœ¬é‡‡é›†ï¼š
  - CPU ä½¿ç”¨ç‡
  - å†…å­˜ä½¿ç”¨ç‡
  - ç£ç›˜ä½¿ç”¨ç‡

    - è„šæœ¬æ¥è‡ªç½‘ç»œç”Ÿæˆï¼š

      ```
      import psutil
      import time
      
      def collect_metrics():
          # è·å– CPU ä½¿ç”¨ç‡ï¼Œinterval=1 è¡¨ç¤º 1 ç§’å†…å¹³å‡å€¼
          cpu_usage = psutil.cpu_percent(interval=1)
          memory = psutil.virtual_memory()
          disk = psutil.disk_usage('/')
      
          print("===== System Metrics =====")
          print(f"CPU Usage: {cpu_usage}%")
          print(f"Memory Usage: {memory.percent}%")
          print(f"Disk Usage: {disk.percent}%")
          print(f"Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S')}")
          print("==========================")
      
      if __name__ == "__main__":
          collect_metrics()
      
      ```

      

### ã€è¦æ±‚ã€‘

- è„šæœ¬å¯ç‹¬ç«‹è¿è¡Œ

- æ¯æ¬¡è¿è¡Œéƒ½èƒ½è¾“å‡ºæœ€æ–°æ•°å€¼

  ![image-20251216231731122](./images/image-20251216231731122.png)

  å½“å‰è™šæ‹Ÿæœºå¤„äºç©ºè½½çŠ¶æ€ï¼ŒCPUä½¿ç”¨ç‡å˜åŒ–ä¸å¤§

- ä»£ç æœ‰åŸºç¡€æ³¨é‡Š

  ![image-20251216232512968](./images/image-20251216232512968.png)

  ä¸­é—´æœ‰ä¸€ä¸ªå°é—®é¢˜å°±æ˜¯ï¼šâ‘ å¤„å‘ç°è„šæœ¬æ–‡ä»¶æ”¾é”™ä½ç½®äº†ï¼Œç§»åŠ¨ä¸€ä¸‹å°±å¥½äº†

  - æœ€åå°è¯•æ¨é€åˆ°github

    - éœ€è¦æ³¨æ„çš„ä¸€ç‚¹å°±æ˜¯ï¼ŒGitHub å·²ç»ç¦ç”¨äº†å¯†ç è®¤è¯ï¼Œåœ¨ Linux ä¸Šé€šè¿‡é…ç½® SSH Key è¿›è¡Œèº«ä»½è®¤è¯ï¼Œé¿å…æ˜æ–‡å‡­è¯ï¼ŒåŒæ—¶ä¹Ÿæ›´é€‚åˆè‡ªåŠ¨åŒ–å’Œé•¿æœŸä½¿ç”¨ã€‚

      ![image-20251217001550673](./images/image-20251217001550673.png)

      æ¨é€æˆåŠŸäº†

------

## ç¬¬ 3 å¤©ï¼šMySQL æ•°æ®åº“è®¾è®¡

### ã€ä»»åŠ¡ã€‘

- åˆ›å»ºç›‘æ§æ•°æ®åº“

![image-20251217222643963](./images/image-20251217222643963.png)

- åˆ›å»ºç›‘æ§æ•°æ®è¡¨

  ```
  USE monitor_db;
  
  CREATE TABLE system_metrics (
      id INT PRIMARY KEY AUTO_INCREMENT,
      cpu_usage FLOAT NOT NULL,
      mem_usage FLOAT NOT NULL,
      disk_usage FLOAT NOT NULL,
      created_at DATETIME NOT NULL
  );
  ```

  ![image-20251217222757724](./images/image-20251217222757724.png)

- ä¿å­˜ SQL æ–‡ä»¶

  åˆ›å»ºè„šæœ¬

  ```
  import psutil
  import pymysql
  from datetime import datetime
  
  cpu = psutil.cpu_percent(interval=1)
  mem = psutil.virtual_memory().percent
  disk = psutil.disk_usage('/').percent
  now = datetime.now()
  
  conn = pymysql.connect(
      host='localhost',
      user='monitor',
      password='monitor123',
      database='monitor_db'
  )
  
  cursor = conn.cursor()
  
  sql = """
  INSERT INTO system_metrics (cpu_usage, mem_usage, disk_usage, created_at)
  VALUES (%s, %s, %s, %s)
  """
  
  cursor.execute(sql, (cpu, mem, disk, now))
  conn.commit()
  
  cursor.close()
  conn.close()
  
  print("æ•°æ®å·²æˆåŠŸå†™å…¥ MySQL")
  ```

  é‡åˆ°ä¸€ä¸ªé—®é¢˜

  ```
  pymysql.err.OperationalError: (1698, "Access denied for user 'root'@'localhost'")
  ```

  **Ubuntu 24.04 ä¸‹ MySQL çš„ root é»˜è®¤ä¸å…è®¸å¯†ç ç™»å½•**

  è¿™æ˜¯ **Ubuntu ç³»ç»Ÿçš„å®‰å…¨è®¾è®¡**

  åœ¨ Ubuntu / Debian ç³»ç»Ÿä¸­ï¼š

  - MySQL çš„ `root` ç”¨æˆ·
  - **é»˜è®¤ä½¿ç”¨ `auth_socket` è®¤è¯**
  - åªå…è®¸ **Linux çš„ root ç”¨æˆ·é€šè¿‡ `sudo mysql` ç™»å½•**
  - âŒ ä¸å…è®¸æ™®é€šç¨‹åºï¼ˆPython / pymysqlï¼‰ç”¨ `root` ç›´æ¥è¿

  æ‰€ä»¥ä¼šçœ‹åˆ°ï¼š

  ```
  Access denied for user 'root'@'localhost'
  ```

  ğŸ‘‰ **è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸æ˜¯é”™è¯¯æ“ä½œ**

  ã€æ¨èæ–¹æ¡ˆã€‘åˆ›å»ºä¸€ä¸ªâ€œç›‘æ§ä¸“ç”¨ MySQL ç”¨æˆ·â€

  #### åˆ›å»ºä¸€ä¸ªä¸“ç”¨ç”¨æˆ·ï¼ˆåªç»™å¿…è¦æƒé™ï¼‰

  ```
  CREATE USER 'monitor'@'localhost' IDENTIFIED BY 'monitor123';
  ```

  > è¯´æ˜ï¼š
  >
  > - ç”¨æˆ·åï¼š`monitor`
  > - å¯†ç ï¼š`monitor123`ï¼ˆç»ƒä¹ ç”¨å³å¯ï¼‰

  æ­¤æ—¶æœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜

  ```
  'cryptography' package is required for sha256_password or caching_sha2_password
  ```

  è¿™æ˜¯ä¸€ä¸ª**â€œè®¤è¯æ’ä»¶ vs Python é©±åŠ¨ä¾èµ–â€é—®é¢˜**ï¼š

  - MySQL 8 é»˜è®¤è®¤è¯æ–¹å¼ï¼š`caching_sha2_password`

  - PyMySQL è¿æ¥è¿™ç§ç”¨æˆ·æ—¶ï¼š

    - è¦ä¹ˆ ğŸ‘‰ å®‰è£… `cryptography`
    - è¦ä¹ˆ ğŸ‘‰ æŠŠè¯¥ç”¨æˆ·æ”¹æˆ `mysql_native_password`

    #### ã€å¼ºçƒˆæ¨èæ–¹æ¡ˆã€‘ä¿®æ”¹ MySQL ç”¨æˆ·è®¤è¯æ–¹å¼ï¼ˆæœ€ç¨³ã€æœ€å¸¸ç”¨ï¼‰

    > è¿™æ˜¯ **å­¦ä¹ é˜¶æ®µ & è¿ç»´å®è·µä¸­æœ€å¸¸è§æ–¹æ¡ˆ**
    >  ä¸å½±å“ä½ åç»­ Flask / Web / crontab
    >  ä¸å¼•å…¥é¢å¤– Python ä¾èµ–

    å†æ¬¡æµ‹è¯•å†™å…¥æ•°æ®ï¼ŒæˆåŠŸ

    ![image-20251217224416503](./images/image-20251217224416503.png)

    

### ã€è¦æ±‚ã€‘

- è¡¨ä¸­å¿…é¡»åŒ…å«æ—¶é—´å­—æ®µ
- å­—æ®µç±»å‹åˆç†ï¼ˆæµ®ç‚¹å‹ / æ—¶é—´æˆ³ï¼‰

![image-20251217224617502](./images/image-20251217224617502.png)

- èƒ½æ‰‹åŠ¨æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®

![image-20251217224721752](./images/image-20251217224721752.png)

äºŒæ¬¡å†™å…¥æµ‹è¯•ï¼Œæ— è¯¯

------

## ç¬¬ 4 å¤©ï¼šé‡‡é›†æ•°æ®å†™å…¥æ•°æ®åº“

### ã€ä»»åŠ¡ã€‘

- ä½¿ç”¨ pymysql è¿æ¥ MySQL
- å°†é‡‡é›†åˆ°çš„ç³»ç»Ÿæ•°æ®å†™å…¥æ•°æ®åº“
- å¤„ç†åŸºæœ¬å¼‚å¸¸æƒ…å†µ

### ã€è¦æ±‚ã€‘

- è„šæœ¬è¿è¡Œä¸€æ¬¡ï¼Œæ•°æ®åº“æ–°å¢ä¸€æ¡è®°å½•
- æ•°æ®å­—æ®µå€¼çœŸå®å¯ä¿¡
- æ•°æ®åº“è¿æ¥å¤±è´¥æ—¶ç¨‹åºä¸å´©æºƒ

------

## ç¬¬ 5 å¤©ï¼šcron å®šæ—¶ä»»åŠ¡é‡‡é›†

### ã€ä»»åŠ¡ã€‘

- ä½¿ç”¨ crontab é…ç½®å®šæ—¶é‡‡é›†
- éªŒè¯å®šæ—¶ä»»åŠ¡æ­£å¸¸æ‰§è¡Œ

### ã€è¦æ±‚ã€‘

- æ¯åˆ†é’Ÿè‡ªåŠ¨å†™å…¥æ•°æ®
- ä½¿ç”¨ç»å¯¹è·¯å¾„
- é‡å¯ç³»ç»Ÿå cron ä¾ç„¶ç”Ÿæ•ˆ

------

## ç¬¬ 6 å¤©ï¼šFlask Web åç«¯æ¥å£

### ã€ä»»åŠ¡ã€‘

- æ­å»º Flask Web æœåŠ¡

å®¿ä¸»æœºå¯ä»¥è®¿é—®

![image-20251217230928038](./images/image-20251217230928038.png)

è™šæ‹Ÿæœºæœ¬åœ°

![image-20251217231819071](./images/image-20251217231819071.png)

- æä¾›æŸ¥è¯¢ç›‘æ§æ•°æ®çš„ API æ¥å£

### ã€è¦æ±‚ã€‘

- æµè§ˆå™¨è®¿é—®æ¥å£è¿”å› JSON æ•°æ®

![image-20251217233020121](./images/image-20251217233020121.png)

ä½†æ˜¯å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å›¾ä¸­çš„JSå­—æ ·

![image-20251217233113782](./images/image-20251217233113782.png)

æŸ¥çœ‹äº†ä¸€ä¸‹é¡µé¢æºç ï¼Œå¹¶æ²¡æœ‰ï¼Œæäº†åŠå¤©æ˜¯æµè§ˆå™¨çš„é—®é¢˜

```
Data available from the console:

$json.data - The parsed JSON object
$json.text - The original JSON text
$json.headers - HTTP request and response headers
```

â€‹	**Firefox åœ¨ä½ æŸ¥çœ‹ JSON æ—¶ï¼Œä¼šè‡ªåŠ¨ï¼š**

â€‹		æŠŠ JSON è§£ææˆ **JS å¯¹è±¡**

â€‹		å¹¶åœ¨ DevTools é‡Œç”¨ **JavaScript ç¯å¢ƒå±•ç¤º**

â€‹		æœ‰äº›å­—æ®µåœ¨ã€Œæ ‘å½¢è§†å›¾ã€é‡Œä¼šè¢«æ ‡æ³¨ä¸º **JS Number / JS value**

æ¢äº†è°·æ­Œæµè§ˆå™¨ï¼ˆå®‰è£…å‚è€ƒUbuntu 24.04ä¸Šå®‰è£… Google Chrome æµè§ˆå™¨ - xiaochong0302çš„æ–‡ç«  - çŸ¥ä¹
https://zhuanlan.zhihu.com/p/719864904ï¼‰ï¼Œä¸€ç‚¹æ²¡é—®é¢˜

![image-20251217235754726](./images/image-20251217235754726.png)

ç°åœ¨å·²ç»ä¹±äº†ï¼Œåšåˆ°å“ªé‡Œå°±å†™å“ªé‡Œäº†

# ç¬¬ 5 å¤©

## å‰ç«¯é¡µé¢ + JS æ‹‰å–æ¥å£ + å±•ç¤ºæ•°æ®ï¼ˆä» 0 åˆ° 1ï¼‰

> ç›®æ ‡ä¸€å¥è¯ï¼š
>  **ç”¨æµè§ˆå™¨æŠŠä½ é‡‡é›†åˆ°çš„ç³»ç»Ÿæ•°æ®â€œçœ‹è§â€**

------

## ä¸€ã€ç¬¬ 5 å¤©æ€»ç›®æ ‡ï¼ˆå…ˆçŸ¥é“åœ¨å¹²ä»€ä¹ˆï¼‰

å®Œæˆåä½ å°†æ‹¥æœ‰ï¼š

- ä¸€ä¸ªç½‘é¡µ `index.html`
- ä¸€ä¸ª JS æ–‡ä»¶ `main.js`
- æµè§ˆå™¨é€šè¿‡ `fetch` è°ƒç”¨ `/metrics`
- é¡µé¢èƒ½**åŠ¨æ€æ˜¾ç¤º CPU / å†…å­˜ / ç£ç›˜ / æ—¶é—´**
- åç«¯ â†’ å‰ç«¯ â†’ æµè§ˆå™¨ å…¨é“¾è·¯æ‰“é€š âœ…

------

## äºŒã€ç¬¬ 5 å¤©ä»»åŠ¡æ‹†åˆ†ï¼ˆä»»åŠ¡ + è¦æ±‚ + æ€»ç»“ï¼‰

------

### âœ… ä»»åŠ¡ 1ï¼šåˆ›å»ºå‰ç«¯ç›®å½•ç»“æ„

#### ğŸ“Œ è¦åšä»€ä¹ˆ

åœ¨ `monitor` é¡¹ç›®ä¸‹ï¼š

```
mkdir templates static
```

ç›®å½•æœ€ç»ˆç»“æ„åº”ä¸ºï¼š

```
monitor/
â”œâ”€â”€ app.py
â”œâ”€â”€ save_to_mysql.py
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ index.html
â”œâ”€â”€ static/
â”‚   â””â”€â”€ main.js
â””â”€â”€ venv/
```

#### âœ… è¦æ±‚

- `templates` ç”¨äº HTMLï¼ˆFlask çº¦å®šï¼‰
- `static` ç”¨äº JS / CSSï¼ˆFlask çº¦å®šï¼‰
- ä¸è¦ä¹±æ”¾æ–‡ä»¶

#### ğŸ§  æ€»ç»“

> Flask **ä¸ä¼šéšä¾¿æ‰¾ HTML**ï¼Œ
>  `templates/` å’Œ `static/` æ˜¯**çº¦å®šä¼˜äºé…ç½®**

------

### âœ… ä»»åŠ¡ 2ï¼šä¿®æ”¹ Flaskï¼Œæ”¯æŒé¡µé¢è®¿é—®

#### ğŸ“Œ æ‰“å¼€ `app.py`

åŠ ä¸Šä¸€ä¸ªé¡µé¢è·¯ç”±ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰ï¼š

```
from flask import Flask, jsonify, render_template
import pymysql

app = Flask(__name__)

@app.route("/")
def index():
    return render_template("index.html")
```

âš ï¸ ä¿ç•™ä½ åŸæ¥çš„ `/metrics` æ¥å£ï¼Œä¸è¦åˆ ã€‚

#### âœ… è¦æ±‚

- æµè§ˆå™¨è®¿é—® `http://127.0.0.1:5000/`

- ä¸æŠ¥é”™ï¼ˆå“ªæ€•é¡µé¢æ˜¯ç©ºçš„ï¼‰

  ç”µè„‘é‡æ–°å¼€æœºï¼Œå…ˆè¿›å…¥è™šæ‹Ÿç¯å¢ƒ

  ```
  cd ~/monitor
  source venv/bin/activate
  ```

  ç„¶åå¯åŠ¨è„šæœ¬

  ```
  python3 app.py
  ```

  Flask æ˜¯**æ¨¡å—åŒ–è®¾è®¡**çš„ï¼š

  - `Flask` â†’ åˆ›å»ºåº”ç”¨
  - `jsonify` â†’ è¿”å› JSON
  - `render_template` â†’ æ¸²æŸ“ HTML

  çœ‹ç»“æœ

  ![image-20251223225752235](./images/image-20251223225752235.png)

  ç›®å‰htmlæ–‡ä»¶ä¸­æ²¡æœ‰å†™ä»»ä½•å†…å®¹ï¼Œç©ºç™½é¡µé¢æ²¡æœ‰é—®é¢˜

------

### âœ… ä»»åŠ¡ 3ï¼šç¼–å†™æœ€ç®€å•çš„ HTML é¡µé¢

#### ğŸ“Œ åˆ›å»º `templates/index.html`

```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç³»ç»Ÿç›‘æ§é¢æ¿</title>
</head>
<body>

<h1>ç³»ç»Ÿç›‘æ§æ•°æ®</h1>

<div id="data">
    æ­£åœ¨åŠ è½½æ•°æ®...
</div>

<script src="/static/main.js"></script>
</body>
</html>
```

#### âœ… è¦æ±‚

- é¡µé¢èƒ½æ­£å¸¸æ‰“å¼€
- æ˜¾ç¤ºã€Œæ­£åœ¨åŠ è½½æ•°æ®...ã€

#### ğŸ§  æ€»ç»“

> HTML åªè´Ÿè´£ **å ä½**
>  çœŸæ­£çš„æ•°æ®äº¤ç»™ JS

------

### âœ… ä»»åŠ¡ 4ï¼šç”¨ JS è°ƒç”¨åç«¯æ¥å£

#### ğŸ“Œ åˆ›å»º `static/main.js`

```
fetch("/metrics")
    .then(response => response.json())
    .then(data => {
        console.log("åç«¯è¿”å›çš„æ•°æ®ï¼š", data);

        const div = document.getElementById("data");
        let html = "";

        data.forEach(item => {
            html += `
                <p>
                    æ—¶é—´ï¼š${item.created_at}<br>
                    CPUï¼š${item.cpu_usage}%<br>
                    å†…å­˜ï¼š${item.mem_usage}%<br>
                    ç£ç›˜ï¼š${item.disk_usage}%
                </p>
                <hr>
            `;
        });

        div.innerHTML = html;
    })
    .catch(err => {
        console.error(err);
        document.getElementById("data").innerText = "åŠ è½½å¤±è´¥";
    });
```

#### âœ… è¦æ±‚

- Chrome æ§åˆ¶å°æ— çº¢è‰²æŠ¥é”™
- é¡µé¢æ˜¾ç¤ºæ•°æ®åº“é‡Œçš„æ•°æ®
- `console.log` èƒ½çœ‹åˆ° JSON

![image-20251223230501309](./images/image-20251223230501309.png)

å†æ¬¡å°è¯•å†™å…¥ä¸€æ¡æ•°æ®

```
python3 save_to_mysql.py
python3 app.py
```

![image-20251223231015726](./images/image-20251223231015726.png)

åˆ·æ–°é¡µé¢ï¼š4æ¡æ•°æ®ï¼Œæ²¡æœ‰é—®é¢˜

![image-20251223231132829](./images/image-20251223231132829.png)

# ç¬¬ 6 å¤©ï¼šECharts æ‰“é€ æœåŠ¡å™¨ç›‘æ§çœ‹æ¿ï¼ˆæ ¸å¿ƒå±•ç¤ºï¼‰

## ğŸ¯ ä»Šå¤©ç›®æ ‡ï¼ˆå…ˆçœ‹ç»“æœï¼‰

å®Œæˆåï¼Œä½ çš„é¡µé¢å°†å…·å¤‡ï¼š

- âœ… CPU ä½¿ç”¨ç‡æŠ˜çº¿å›¾
- âœ… å†…å­˜ä½¿ç”¨ç‡æŠ˜çº¿å›¾
- âœ… ç£ç›˜ä½¿ç”¨ç‡æŠ˜çº¿å›¾
- âœ… æ—¶é—´è½´å±•ç¤ºå†å²è¶‹åŠ¿

> è¿™ä¸€æ­¥ **ç›´æ¥å†³å®šä½ é¡¹ç›®å±•ç¤ºæ•ˆæœå’Œç®€å†è¯´æœåŠ›**

------

## ä¸€ã€å…ˆç¡®è®¤ä½ çš„é¡¹ç›®ç›®å½•ï¼ˆéå¸¸é‡è¦ï¼‰

åœ¨ `~/monitor` ä¸‹æ‰§è¡Œï¼š

```
ls
```

ä½ ç°åœ¨åº”è¯¥è‡³å°‘æœ‰ï¼š

```
app.py
save_to_mysql.py
collect_metrics.py
venv/
```

------

## äºŒã€åˆ›å»ºæ ‡å‡† Flask ç›®å½•ç»“æ„ï¼ˆåƒçœŸå®é¡¹ç›®ï¼‰

### 1ï¸âƒ£ åˆ›å»º templates ç›®å½•

```
mkdir templates
```

### 2ï¸âƒ£ åˆ›å»ºå‰ç«¯é¡µé¢

```
nano templates/index.html
```

------

## ä¸‰ã€å®Œæ•´ `index.html`ï¼ˆä½  **åŸæ ·å¤åˆ¶**ï¼‰

> âš ï¸ ä¸è¦æ”¹å˜é‡åï¼Œå…ˆè·‘é€š

```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æœåŠ¡å™¨æ€§èƒ½ç›‘æ§</title>

    <!-- å¼•å…¥ ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
</head>
<body>

<h2>æœåŠ¡å™¨æ€§èƒ½ç›‘æ§é¢æ¿</h2>

<div id="cpu" style="width: 800px; height: 300px;"></div>
<div id="mem" style="width: 800px; height: 300px;"></div>
<div id="disk" style="width: 800px; height: 300px;"></div>

<script>
fetch("/metrics")
  .then(res => res.json())
  .then(data => {

    // æ•°æ®åè½¬ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
    data.reverse();

    let times = data.map(i => i.created_at);
    let cpu = data.map(i => i.cpu_usage);
    let mem = data.map(i => i.mem_usage);
    let disk = data.map(i => i.disk_usage);

    function draw(id, title, values) {
        let chart = echarts.init(document.getElementById(id));
        chart.setOption({
            title: { text: title },
            tooltip: { trigger: 'axis' },
            xAxis: { type: 'category', data: times },
            yAxis: { type: 'value', max: 100 },
            series: [{
                type: 'line',
                data: values,
                smooth: true
            }]
        });
    }

    draw("cpu", "CPU ä½¿ç”¨ç‡ (%)", cpu);
    draw("mem", "å†…å­˜ ä½¿ç”¨ç‡ (%)", mem);
    draw("disk", "ç£ç›˜ ä½¿ç”¨ç‡ (%)", disk);
});
</script>

</body>
</html>
```

ä¿å­˜é€€å‡ºï¼š
 `Ctrl + O` â†’ å›è½¦ â†’ `Ctrl + X`

------

## å››ã€ç¡®è®¤ Flask èƒ½æ‰¾åˆ°è¿™ä¸ªé¡µé¢

ä½ çš„ `app.py` é‡Œè¿™æ®µå·²ç»æ˜¯å¯¹çš„ï¼š

```
@app.route("/")
def index():
    return render_template("index.html")
```

------

## äº”ã€é‡å¯ Flask

```
Ctrl + C
python3 app.py
```

çœ‹åˆ°ï¼š

```
Running on http://0.0.0.0:5000/
```

------

## å…­ã€æµè§ˆå™¨è®¿é—®ï¼ˆå…³é”®æ—¶åˆ»ï¼‰

æ‰“å¼€ï¼š

```
http://127.0.0.1:5000/
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

- ä¸‰ä¸ªæŠ˜çº¿å›¾
- æ¨ªè½´æ˜¯æ—¶é—´
- çºµè½´æ˜¯ç™¾åˆ†æ¯”
- æ›²çº¿èƒ½å˜åŒ–

![image-20251223233724532](./images/image-20251223233724532.png)

â€œè¿™ChatGPTæœ‰æ—¶å€™ä¹ŸæŒºè®©äººå¤´ç–¼çš„â€œ

**ç»è¿‡äº†æ¼«é•¿çš„æ£€æŸ¥å**

âŒ é—®é¢˜ä¸åœ¨ä½ çš„ JS
 âŒ é—®é¢˜ä¸åœ¨ Flask
 âŒ é—®é¢˜ä¸åœ¨ `/metrics`

ğŸ‘‰ **é—®é¢˜ 100% å‡ºåœ¨è¿™ä¸€è¡Œï¼š**

```
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
```

------

## ä¸€ã€æ ¹å› åˆ†æï¼ˆä¸ºä»€ä¹ˆä¼š `echarts is not defined`ï¼‰

### jsDelivr çš„è§„åˆ™æ˜¯ï¼š

> **å¿…é¡»æŒ‡å®šç‰ˆæœ¬å·**

ä½ ç°åœ¨ç”¨çš„æ˜¯ï¼š

```
https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js
```

è¿™ä¸ªåœ°å€åœ¨ **å¾ˆå¤šç¯å¢ƒä¸‹ä¼šï¼š**

- è¿”å› 404
- è¢« CDN é‡ç½®ï¼ˆ`ERR_CONNECTION_RESET`ï¼‰
- å®é™…æ²¡æœ‰åŠ è½½ä»»ä½• JS

**ç»“æœå°±æ˜¯ï¼š**

```
echarts === undefined
```

ä½†æµè§ˆå™¨ä¸ä¼šåœ¨ HTML ä¸­ç›´æ¥æŠ¥é”™ï¼Œåªä¼šåœ¨ä½ ç”¨å®ƒçš„æ—¶å€™ç‚¸ã€‚

------

## äºŒã€ç«‹åˆ»ä¿®å¤ï¼ˆæ¨è 2 ç§æ–¹å¼ï¼‰

### âœ… æ–¹æ¡ˆä¸€ï¼ˆæœ€æ¨èï¼‰ï¼šæŒ‡å®šç‰ˆæœ¬å·ï¼ˆç¨³å®šï¼‰

æŠŠè¿™ä¸€è¡Œ **ç›´æ¥æ›¿æ¢** ä¸ºï¼š

```
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
```

è¿™æ˜¯ **ECharts 5 çš„ç¨³å®šç‰ˆæœ¬**ã€‚

------

### âœ… æ–¹æ¡ˆäºŒï¼ˆå›½å†…æ›´ç¨³ï¼‰ï¼šStaticfile CDN

å¦‚æœä½ åœ¨å›½å†… / CDN ä¸ç¨³å®šï¼Œç›´æ¥ç”¨è¿™ä¸ªï¼š

```
<script src="https://cdn.staticfile.org/echarts/5.4.3/echarts.min.js"></script>
```

ğŸ‘‰ **å¯¹æ–°æ‰‹ & è¿ç»´å­¦ä¹ è€…æ›´å‹å¥½**

ç›´æ¥ç”¨æ–¹æ¡ˆäºŒï¼Œç»“æœå±•ç¤ºï¼š
![image-20251223235335231](./images/image-20251223235335231.png)

## ä¸ƒã€ä»Šå¤©å®Œæˆäº†ä»€ä¹ˆï¼Ÿ

> âœ” ä½¿ç”¨ Flask æä¾›ç›‘æ§æ•°æ® API
>  âœ” ä½¿ç”¨ ECharts æ„å»ºå®æ—¶æ€§èƒ½ç›‘æ§çœ‹æ¿
>  âœ” å®ç°æœåŠ¡å™¨ CPU / å†…å­˜ / ç£ç›˜è¶‹åŠ¿å¯è§†åŒ–
>  âœ” ç›‘æ§æ•°æ®ä»é‡‡é›† â†’ å­˜å‚¨ â†’ å±•ç¤ºçš„å®Œæ•´é“¾è·¯

#  ç¬¬ 5 å¤©

[^]: ï¼ˆAIæ€»æ˜¯ä¼šåœ¨æ„æƒ³ä¸åˆ°çš„åœ°æ–¹å‡ºé”™ï¼‰

## ä¸»é¢˜ï¼šé‡‡é›†è‡ªåŠ¨åŒ– + åŸºç¡€å‘Šè­¦æœºåˆ¶ï¼ˆè¿ç»´æ„è¯†æå‡æ—¥ï¼‰

> è¿™ä¸€æ•´å¤©çš„ç›®æ ‡åªæœ‰ä¸€å¥è¯ï¼š
>  **â€œè®©ç³»ç»Ÿè‡ªå·±è·‘èµ·æ¥ï¼Œå¹¶åœ¨å¼‚å¸¸æ—¶ç»™ä½ æç¤ºã€‚â€**

------

## ä¸€ã€ä»Šå¤©ä½ åœ¨ã€Œé¡¹ç›®ç»å†ã€é‡Œè¦è¡¥å¼ºçš„èƒ½åŠ›ç‚¹

- è¿ç»´ä¸æ˜¯â€œæ‰‹åŠ¨è·‘è„šæœ¬â€
- è¿ç»´ä¸€å®šè¦æœ‰ï¼š
  - **è‡ªåŠ¨é‡‡é›†**
  - **å¼‚å¸¸æ„è¯†ï¼ˆå“ªæ€•æ˜¯æœ€ç®€é™‹çš„ï¼‰**
- è®©é¢è¯•å®˜çœ‹åˆ°ä½ **ä¸æ˜¯åªä¼šç”»å›¾**

------

## äºŒã€ä»Šæ—¥ä»»åŠ¡æ‹†è§£ï¼ˆä»»åŠ¡ + è¦æ±‚ + å®Œæˆæ ‡å‡†ï¼‰

------

## âœ… ä»»åŠ¡ä¸€ï¼šé‡‡é›†è„šæœ¬è‡ªåŠ¨åŒ–ï¼ˆcrontabï¼‰

### ğŸ¯ ç›®æ ‡

è®© `collect_metrics.py + save_to_mysql.py` **è‡ªåŠ¨å®šæ—¶è¿è¡Œ**

------

### ä½ è¦åšçš„äº‹

1ï¸âƒ£ åˆå¹¶æˆ–ä¸²è”é‡‡é›†ä¸å…¥åº“é€»è¾‘
 ï¼ˆæ¨èï¼šä¸€ä¸ªè„šæœ¬å®Œæˆé‡‡é›† + å†™åº“ï¼‰

â€‹	å¯¹ä¹‹å‰çš„é‡‡é›†å’Œå…¥åº“è¿›è¡Œäº†è§„èŒƒï¼Œå°±ä¸è´´ä»£ç äº†

â€‹	å‡ºç°äº†ä¸€ä¸ªå°´å°¬çš„å°é—®é¢˜ï¼Œè¿›å…¥monitoræ•°æ®åº“ç”¨æˆ·çš„æ—¶å€™å¿˜è®°å¯†ç äº†ï¼Œä¹‹å‰åœ¨ `save_to_mysql.py` é‡Œä½¿ç”¨çš„æ•°æ®åº“ç”¨æˆ·å¯†ç ï¼š

```
user="monitor",
password="monitor123",
```



#### è¿™ä¸ªç”¨æˆ· `monitor` æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª**å…¸å‹çš„è¿ç»´è®¾è®¡**ï¼š

| ç”¨æˆ·    | ç”¨é€”                       |
| ------- | -------------------------- |
| root    | ç®¡ç†æ•°æ®åº“ï¼ˆå»ºåº“ã€å»ºç”¨æˆ·ï¼‰ |
| monitor | åº”ç”¨ç¨‹åºå†™ç›‘æ§æ•°æ®         |

### è¿›å…¥ MySQL

```
mysql -u monitor -p
USE monitor_db;
```

------

###  æŸ¥çœ‹æœ€æ–°ä¸€æ¡æ•°æ®

```
SELECT cpu_usage, mem_usage, disk_usage, created_at
FROM system_metrics
ORDER BY created_at DESC
LIMIT 3;
```





2ï¸âƒ£ ä½¿ç”¨ `crontab` æ¯åˆ†é’Ÿé‡‡é›†ä¸€æ¬¡



#### 1ï¸âƒ£ æ–°å»ºè„šæœ¬ `collector/run_collector.py`

é€»è¾‘ç»“æ„ï¼š

```
from collect_metrics import collect_metrics
from save_to_mysql import save_to_db

data = collect_metrics()
save_to_db(data)
```

> ä½ ä¹‹å‰å·²ç»æŠŠåŠŸèƒ½æ‹†å¾—å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥å°±æ˜¯**è¿ç»´å¼æ•´åˆ**

------

#### 2ï¸âƒ£ æµ‹è¯•è„šæœ¬

```
(venv) python3 collector/run_collector.py
```

æ•°æ®åº“ä¸­ **æ–°å¢ä¸€æ¡è®°å½•** â†’ æˆåŠŸ âœ…

------

#### 3ï¸âƒ£ å†™ crontab

```
crontab -e
```

åŠ å…¥ä¸€è¡Œï¼ˆæ³¨æ„ä½¿ç”¨ venv çš„ pythonï¼‰ï¼š

```
*/1 * * * * /usr/bin/python3 /home/tt/monitor/collector/run_collector.py >> /home/tt/monitor/collector/collector.log 2>&1
```

### è¿™è¡Œå‘½ä»¤æ˜¯ä»€ä¹ˆæ„æ€ï¼ˆä½ å¿…é¡»æ‡‚ï¼‰ğŸ‘‡

| éƒ¨åˆ†               | è¯´æ˜         |
| ------------------ | ------------ |
| `*/1 * * * *`      | æ¯ 1 åˆ†é’Ÿ    |
| `/usr/bin/python3` | æŒ‡å®š Python  |
| `run_collector.py` | æ‰§è¡Œé‡‡é›†ç¨‹åº |
| `>> collector.log` | è¿½åŠ æ—¥å¿—     |
| `2>&1`             | é”™è¯¯ä¹Ÿå†™æ—¥å¿— |

------

### âœ… å®Œæˆæ ‡å¿—

- ç­‰ 3 åˆ†é’Ÿ

- MySQL ä¸­å¤šäº† 3 æ¡æ–°æ•°æ®

  ![image-20251227233139285](./images/image-20251227233139285.png)

  ![image-20251227233120273](./images/image-20251227233120273.png)

  

- é¡µé¢åˆ·æ–°ï¼Œå›¾è¡¨è‡ªåŠ¨å˜é•¿

  å›åˆ°ç›‘æ§é¢æ¿

  ![image-20251227235740541](./images/image-20251227235740541.png)

------

## âœ… ä»»åŠ¡äºŒï¼šæœ€åŸºç¡€çš„â€œè¿ç»´å‘Šè­¦æ„è¯†â€

> **ä¸æ˜¯çŸ­ä¿¡ã€ä¸æ˜¯é‚®ä»¶**
>  ğŸ‘‰ æ˜¯ï¼š**â€œç³»ç»Ÿå·²ç»çŸ¥é“ä¸æ­£å¸¸äº†â€**

------

- ## ğŸš¨ æ„å»ºæœåŠ¡å™¨æ€§èƒ½å‘Šè­¦ç³»ç»Ÿï¼ˆCPU / å†…å­˜ / ç£ç›˜ï¼‰

  > ç›®æ ‡ï¼š
  >  å½“æœåŠ¡å™¨èµ„æºè¶…è¿‡é˜ˆå€¼æ—¶ï¼Œ**è‡ªåŠ¨è§¦å‘å‘Šè­¦ï¼ˆå…ˆç”¨æ§åˆ¶å° + æ—¥å¿—ï¼‰**

  è¿™æ˜¯æ‰€æœ‰ç›‘æ§ç³»ç»Ÿï¼ˆZabbix / Prometheus / äº‘ç›‘æ§ï¼‰çš„**æ ¸å¿ƒæ€æƒ³**ã€‚

  ------

  ## ä¸€ã€è®¾è®¡æ€è·¯ï¼ˆå…ˆåˆ«å†™ä»£ç ï¼‰

  æˆ‘ä»¬è¦åšçš„äº‹ï¼š

  ```
  é‡‡é›†æ•°æ®
     â†“
  åˆ¤æ–­æ˜¯å¦è¶…é˜ˆå€¼
     â†“
  è§¦å‘å‘Šè­¦ï¼ˆæ‰“å° / è®°å½•ï¼‰
  ```

  ------

  ## äºŒã€è®¾å®šå‘Šè­¦è§„åˆ™ï¼ˆä½ ç°åœ¨è¿™æ ·å®šå°±å¯¹ï¼‰

  ```
  CPU ä½¿ç”¨ç‡   > 80%  â†’ å‘Šè­¦
  å†…å­˜ä½¿ç”¨ç‡  > 85%  â†’ å‘Šè­¦
  ç£ç›˜ä½¿ç”¨ç‡  > 90%  â†’ å‘Šè­¦
  ```

  ------

  ## ä¸‰ã€æ–°å»ºå‘Šè­¦æ¨¡å—ï¼ˆéå¸¸é‡è¦ï¼‰

  ### ğŸ“ æ–°æ–‡ä»¶

  ```
  collector/alert.py
  ```

  ------

  ### ğŸ“„ alert.pyï¼ˆç›´æ¥ç…§æŠ„ï¼‰

  ```
  from datetime import datetime
  
  CPU_THRESHOLD = 80
  MEM_THRESHOLD = 85
  DISK_THRESHOLD = 90
  
  def check_alert(cpu, mem, disk):
      alerts = []
      now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
  
      if cpu > CPU_THRESHOLD:
          alerts.append(f"[{now}] âš  CPU ä½¿ç”¨ç‡è¿‡é«˜: {cpu}%")
  
      if mem > MEM_THRESHOLD:
          alerts.append(f"[{now}] âš  å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {mem}%")
  
      if disk > DISK_THRESHOLD:
          alerts.append(f"[{now}] âš  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: {disk}%")
  
      return alerts
  ```

  ------

  ## å››ã€æ”¹é€  run_collector.pyï¼ˆæ ¸å¿ƒæ•´åˆï¼‰

  ### ç¤ºä¾‹ç»“æ„ï¼ˆé‡ç‚¹çœ‹é€»è¾‘ï¼‰

  ```
  from collect_metrics import collect_metrics
  from save_to_mysql import save_to_mysql
  from alert import check_alert
  
  def main():
      cpu, mem, disk = collect_metrics()
  
      save_to_mysql(cpu, mem, disk)
  
      alerts = check_alert(cpu, mem, disk)
      for alert in alerts:
          print(alert)
  
  if __name__ == "__main__":
      main()
  ```

  âš ï¸ å¦‚æœä½ çš„ `collect_metrics()` ç°åœ¨åªæ˜¯ printï¼Œ
   ä½ éœ€è¦æ”¹æˆ **return æ•°æ®**ã€‚

  ------

  ## äº”ã€éªŒè¯å‘Šè­¦æ˜¯å¦æœ‰æ•ˆï¼ˆå®æˆ˜æŠ€å·§ï¼‰

  ## çœŸå®åœºæ™¯éªŒè¯ï¼ˆæ¨¡æ‹Ÿç”Ÿäº§äº‹æ•…ï¼‰

  ### æ–¹æ³•ä¸€ï¼šåˆ¶é€  CPU å‹åŠ›ï¼ˆæ¨èï¼‰

  ```
  sudo apt install stress -y
  stress --cpu 2 --timeout 60
  ```

  ç„¶ååŒæ—¶æ‰§è¡Œï¼š

  ```
  python run_collector.py
  ```

  ### ä½ åº”çœ‹åˆ°ï¼š

  ```
  âš ï¸ CPU ä½¿ç”¨ç‡è¿‡é«˜: 96.7
  ```

  ### æ–¹æ³•äºŒï¼šå ç”¨å†…å­˜ï¼ˆäº†è§£å³å¯ï¼‰

  ```
  stress --vm 1 --vm-bytes 80% --timeout 30
  ```

  é‡åˆ°ä¸€ä¸ªé—®é¢˜

  ```
  Traceback (most recent call last):
    File "/home/tt/monitor/collector/run_collector.py", line 14, in <module>
      main()
    File "/home/tt/monitor/collector/run_collector.py", line 6, in main
      cpu, mem, disk = collect_metrics()
      ^^^^^^^^^^^^^^
  ValueError: too many values to unpack (expected 3)
  ```

  è¿™ä¸ªæŠ¥é”™**éå¸¸å…¸å‹ï¼Œä¹Ÿéå¸¸æœ‰ä»·å€¼**ï¼Œä½ å·²ç»è¸©åˆ°ã€Œå‡½æ•°è¿”å›å€¼è®¾è®¡ã€è¿™ä¸ªå¾ˆå¤šæ–°æ‰‹éƒ½ä¼šè¸©çš„å‘äº† ğŸ‘
   æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œä¿è¯ä½ **ä¸ä»…ä¿®å¥½ï¼Œè€Œä¸”çŸ¥é“ä¸ºä»€ä¹ˆé”™**ã€‚

  ------

  ## ä¸€ã€é”™è¯¯ç¿»è¯‘æˆäººè¯ï¼ˆå…ˆçœ‹æ‡‚ï¼‰

  æŠ¥é”™æ ¸å¿ƒåªæœ‰è¿™ä¸€å¥ï¼š

  ```
  ValueError: too many values to unpack (expected 3)
  ```

  å‡ºé”™ä»£ç ï¼š

  ```
  cpu, mem, disk = collect_metrics()
  ```

  ğŸ‘‰ **å«ä¹‰**ï¼š

  > `collect_metrics()` è¿”å›çš„å€¼ **æ•°é‡ â‰  3**
  >  ä½†ä½ å´è¯•å›¾ç”¨ 3 ä¸ªå˜é‡å»æ¥

  ------

  ## äºŒã€æ ¹å› åˆ†æï¼ˆä¸€å®šè¦å¯¹ä¸Šä½ è‡ªå·±çš„ä»£ç ï¼‰

  ### ä½ ç°åœ¨çš„ `collect_metrics.py`ï¼ˆæ ¹æ®ä½ å‰é¢è´´çš„ï¼‰

  ```
  def collect_metrics():
      cpu_usage = psutil.cpu_percent(interval=1)
      memory = psutil.virtual_memory()
      disk = psutil.disk_usage('/')
  
      print("===== System Metrics =====")
      print(f"CPU Usage: {cpu_usage}%")
      print(f"Memory Usage: {memory.percent}%")
      print(f"Disk Usage: {disk.percent}%")
      print(f"Timestamp: {time.strftime('%Y-%m-%d %H:%M:%S')}")
      print("==========================")
  ```

  âš ï¸ **å…³é”®é—®é¢˜**ï¼š

  ğŸ‘‰ è¿™ä¸ªå‡½æ•° **æ²¡æœ‰ return**

  åœ¨ Python ä¸­ï¼š

  ```
  def f():
      pass
  ```

  ç­‰ä»·äºï¼š

  ```
  def f():
      return None
  ```

  ä½†ä½ ç°åœ¨çš„æŠ¥é”™æ˜¯ **too many values**ï¼Œè¯´æ˜ä½ åæ¥**æ”¹è¿‡**å®ƒï¼Œå¾ˆå¯èƒ½æ˜¯è¿™æ ·ğŸ‘‡

  ------

  ### å¾ˆå¯èƒ½ä½ ç°åœ¨çš„çœŸå®ä»£ç æ˜¯è¿™ç§ï¼ˆå¸¸è§æƒ…å†µï¼‰

  ```
  return cpu, mem, disk, now
  ```

  æˆ–è€…ï¼š

  ```
  return cpu, mem, disk, created_at
  ```

  â¡ï¸ **è¿”å›äº† 4 ä¸ªå€¼**

  è€Œ `run_collector.py` é‡Œå´æ˜¯ï¼š

  ```
  cpu, mem, disk = collect_metrics()
  ```

  âŒ æ•°é‡å¯¹ä¸ä¸Š â†’ ç›´æ¥æŠ¥é”™

  ## ä¸‰ã€æ ‡å‡†è§£å†³æ–¹æ¡ˆï¼ˆåªæ¨èè¿™ä¸€ç§ï¼‰

  ###  ç»Ÿä¸€ã€Œå‡½æ•°è¿”å›å€¼ = ä½¿ç”¨æ–¹æ¥æ”¶å€¼ã€

  è§£å†³ï¼ï¼ï¼

  å‡ºç°äº†ä¸€ä»¶éå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼š

  ![image-20251228005457276](./images/image-20251228005457276.png)

  åœ¨å‹åŠ›æµ‹è¯•ä¸­ï¼Œcpuå·²ç»å ç”¨50%ä»¥ä¸Šäº†ï¼Œä¸ºäº†æµ‹è¯•å‘Šè­¦æ˜¯å¦ç”Ÿæ•ˆï¼Œæˆ‘å°†cpuçš„å‘Šè­¦å€¼è°ƒæ•´ä¸º3%äº†ï¼Œä½†æ˜¯åå¤æµ‹è¯•éƒ½æ²¡æœ‰å‘Šè­¦ç»“æœï¼š

  > **ä½ çš„å‘Šè­¦é€»è¾‘æ˜¯â€œå¯¹çš„â€ï¼Œåªæ˜¯â€œæ²¡äººæŠŠå®ƒè¯´å‡ºæ¥â€**

  ä¸‹é¢æˆ‘ç”¨ã€Œä¸€å¥è¯ç»“è®º â†’ åŸå›  â†’ æ­£ç¡®æ”¹æ³• â†’ éªŒè¯æ–¹æ³•ã€ç»™ä½ è®²æ¸…æ¥šã€‚

  ------

  #### ä¸€å¥è¯ç»“è®ºï¼ˆé‡ç‚¹ï¼‰
  
  > âŒ ç°åœ¨**æ²¡æœ‰å‘Šè­¦è¾“å‡º**ï¼Œä¸æ˜¯å› ä¸ºæ²¡è§¦å‘
  >  âœ… è€Œæ˜¯å› ä¸º **`check_alert()` åªâ€œè¿”å›äº†å‘Šè­¦â€ï¼Œä½†æ²¡æœ‰ä»»ä½•åœ°æ–¹â€œæ‰“å°æˆ–å¤„ç†å®ƒâ€**

â€‹	è¿™ä¸€æ®µéå¸¸å…³é”® ğŸ‘‡

```
alerts = check_alert(cpu, mem, disk)

for alert in alerts:
    print(alert)
```

ğŸ‘‰ **è¿™ä¸€æ­¥ï¼Œæ‰æ˜¯çœŸæ­£æŠŠâ€œå‘Šè­¦â€å±•ç¤ºå‡ºæ¥**

ç»“æœå±•ç¤º

![image-20251228010508993](./images/image-20251228010508993.png)

------

# ç¬¬ 6 å¤©ç›®æ ‡ï¼ˆä»Šå¤©ä½ åœ¨åšä»€ä¹ˆï¼‰

> **æŠŠâ€œå‘Šè­¦â€ä»æ‰“å°å‡çº§ä¸ºâ€œå¯è¿½æº¯çš„æ•°æ®â€**

ä¹Ÿå°±æ˜¯ï¼š
 **å‘Šè­¦ â†’ å†™å…¥æ•°æ®åº“ â†’ åç»­å¯åœ¨ Web é¡µé¢å±•ç¤º**

è¿™æ˜¯è¿ç»´é¡¹ç›®é‡Œ**éå¸¸å…³é”®çš„ä¸€æ­¥**ã€‚

------

## ä¸€ã€ä»Šå¤©å®Œæˆåï¼Œä½ å°†å…·å¤‡çš„èƒ½åŠ›

å®Œæˆä»Šå¤©åï¼Œä½ å¯ä»¥ï¼š

> å®ç°æœåŠ¡å™¨æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼Œæ”¯æŒ **æŒ‡æ ‡é‡‡é›†ã€é˜ˆå€¼å‘Šè­¦ã€å‘Šè­¦è®°å½•æŒä¹…åŒ–åŠå†å²æŸ¥è¯¢**

------

## äºŒã€ç¬¬ 6 å¤©ä»»åŠ¡æ‹†è§£ï¼ˆä»»åŠ¡ + è¦æ±‚ + éªŒæ”¶ï¼‰

------

## âœ… ä»»åŠ¡ 1ï¼šè®¾è®¡å‘Šè­¦è¡¨ï¼ˆæ•°æ®åº“å±‚ï¼‰

**å‘Šè­¦ç›¸å…³çš„æ•°æ®è¡¨ï¼Œå»ºè®®å°±åœ¨ `monitor_db` è¿™ä¸ªæ•°æ®åº“ä¸­å•ç‹¬åˆ›å»ºä¸€å¼ è¡¨**ï¼ˆä¸æ˜¯åœ¨å·²æœ‰çš„ `system_metrics` è¡¨é‡Œï¼‰ã€‚

------

## ä¸€ã€å½“å‰æ•´ä½“ç»“æ„å›é¡¾ï¼ˆä½ æ²¡èµ°é”™ï¼‰

ç°åœ¨ä½ çš„é¡¹ç›®é€»è¾‘æ˜¯ï¼š

```
collector/
â”œâ”€â”€ collect_metrics.py   # é‡‡é›† CPU / å†…å­˜ / ç£ç›˜
â”œâ”€â”€ save_to_mysql.py     # ä¿å­˜ system_metrics
â”œâ”€â”€ alert.py             # åˆ¤æ–­æ˜¯å¦è§¦å‘å‘Šè­¦
â”œâ”€â”€ run_collector.py     # æ€»å…¥å£
```

ç›®å‰ä½ å·²ç»åšåˆ°ï¼š

- âœ… system_metrics è¡¨åœ¨æŒç»­å†™å…¥
- âœ… crontab æ¯åˆ†é’Ÿæ‰§è¡Œ
- âœ… å‘Šè­¦é€»è¾‘å‡½æ•°å·²å†™å¥½ï¼ˆcheck_alertï¼‰

**ä¸‹ä¸€æ­¥ï¼šéœ€è¦ä¸€ä¸ªåœ°æ–¹â€œå­˜æ”¾å‘Šè­¦ç»“æœâ€**

------

## äºŒã€ä¸ºä»€ä¹ˆè¦å•ç‹¬å»ºä¸€å¼ å‘Šè­¦è¡¨ï¼Ÿ

åŸå› å¾ˆé‡è¦ï¼š

| æ•°æ®ç±»å‹     | è¡¨               |
| ------------ | ---------------- |
| ç›‘æ§åŸå§‹æ•°æ® | `system_metrics` |
| å‘Šè­¦è®°å½•     | `alerts`ï¼ˆæ–°å»ºï¼‰ |

ğŸ‘‰ ä¸è¦æ··åœ¨ä¸€å¼ è¡¨é‡Œï¼Œå¦åˆ™ä»¥åå¾ˆéš¾ç»Ÿè®¡ã€æŸ¥è¯¢ã€å±•ç¤ºã€‚

------

## ä¸‰ã€ä½ è¦åˆ›å»ºçš„è¡¨ï¼šalertsï¼ˆå°±åœ¨ monitor_db é‡Œï¼‰

### 1ï¸âƒ£ è¿›å…¥ MySQL

```
mysql -u monitor -p
```

è¾“å…¥ä½ ä¹‹å‰ç”¨çš„å¯†ç ï¼š

```
monitor123
```

è¿›å…¥åï¼š

```
USE monitor_db;
```

------

### 2ï¸âƒ£ åˆ›å»ºå‘Šè­¦è¡¨ï¼ˆ**ç›´æ¥å¤åˆ¶æ‰§è¡Œ**ï¼‰

```
CREATE TABLE alerts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    alert_type VARCHAR(20) NOT NULL,   -- cpu / mem / disk
    alert_msg VARCHAR(255) NOT NULL,   -- å‘Šè­¦å†…å®¹
    metric_value FLOAT NOT NULL,       -- è§¦å‘å‘Šè­¦çš„å€¼
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### å­—æ®µè§£é‡Š

| å­—æ®µ          | å«ä¹‰             |
| ------------- | ---------------- |
| alert_type    | cpu / mem / disk |
| alert_message | å‘Šè­¦æ–‡æœ¬         |
| alert_value   | å®é™…å€¼           |
| threshold     | è§¦å‘é˜ˆå€¼         |
| created_at    | å‘Šè­¦æ—¶é—´         |

â€‹	è¿™é‡Œé‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œ

```
ERROR 1142 (42000): CREATE command denied to user 'monitor'@'localhost'
```

 å«ä¹‰æ˜¯ï¼š

> **monitor è¿™ä¸ª MySQL ç”¨æˆ·æ²¡æœ‰ CREATE TABLE çš„æƒé™**

å®ƒåªèƒ½ï¼š

- INSERT
- SELECT
- UPDATEï¼ˆå¯èƒ½ï¼‰

ä½† **ä¸èƒ½å»ºè¡¨**ã€‚

## è§£å†³æ–¹æ¡ˆï¼ˆæœ‰ 2 ç§ï¼Œæ¨èç¬¬ 1 ç§ï¼‰

------

## âœ… æ–¹æ¡ˆä¸€ï¼ˆå¼ºçƒˆæ¨èï¼‰ï¼šç”¨ root å»ºè¡¨ï¼ˆæœ€è§„èŒƒï¼‰

### 1ï¸âƒ£ é€€å‡ºå½“å‰ MySQL

```
exit;
```

------

### 2ï¸âƒ£ ç”¨ root ç™»å½• MySQL

```
sudo mysql -u root
```

ï¼ˆUbuntu é»˜è®¤ root æ˜¯å…å¯†ç çš„ï¼‰

------

### 3ï¸âƒ£ åˆ‡æ¢æ•°æ®åº“

```
USE monitor_db;
```

------

### 4ï¸âƒ£ åˆ›å»ºå‘Šè­¦è¡¨ï¼ˆæ³¨æ„è¡¨åï¼‰

```
CREATE TABLE alert_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    alert_type VARCHAR(20) NOT NULL,
    alert_msg VARCHAR(255) NOT NULL,
    metric_value FLOAT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

------

### 5ï¸âƒ£ éªŒè¯

```
SHOW TABLES;
```

çœ‹åˆ°ï¼š

```
system_metrics
alert_logs
```

è¯´æ˜æˆåŠŸ âœ…

------

### 6ï¸âƒ£ é€€å‡º root

```
exit;
```

------

## ï¼ˆå¯é€‰ï¼‰ç»™ monitor ç”¨æˆ·å‘Šè­¦è¡¨å†™å…¥æƒé™

ä¸€èˆ¬ **è‡ªåŠ¨å°±æœ‰ INSERT æƒé™**ï¼Œå¦‚æœä½ æƒ³ç¡®è®¤ï¼š

```
mysql -u monitor -p
USE monitor_db;
INSERT INTO alert_logs (alert_type, alert_msg, metric_value)
VALUES ('cpu', 'test alert', 99);
```

å¦‚æœæ²¡æŠ¥é”™ â†’ æƒé™ OK
 å¦‚æœæŠ¥é”™ â†’ æˆ‘æ•™ä½ è¡¥æˆæƒï¼ˆå¾ˆå°‘éœ€è¦ï¼‰

------

## ä¸ºä»€ä¹ˆæˆ‘ä¸æ¨èä½ ç»™ monitor CREATE æƒé™ï¼Ÿ

å› ä¸ºåœ¨çœŸå®è¿ç»´ä¸­ï¼š

- âŒ é‡‡é›†ç¨‹åº â‰  æ•°æ®åº“ç®¡ç†å‘˜
- âŒ ç¨‹åºèƒ½å»ºè¡¨ = å®‰å…¨éšæ‚£
- âœ… è¡¨ç»“æ„ â†’ ç”± DBA / root ç®¡ç†
- âœ… ç¨‹åº â†’ åªè´Ÿè´£å†™æ•°æ®



### 3ï¸âƒ£ éªŒè¯è¡¨æ˜¯å¦å­˜åœ¨

```
SHOW TABLES;
```

ä½ åº”è¯¥èƒ½çœ‹åˆ°ï¼š

```
system_metrics
alerts
```

![image-20251230220129081](./images/image-20251230220129081.png)

å†çœ‹ç»“æ„ï¼š

```
DESC alerts;
```

![image-20251230220636059](./images/image-20251230220636059.png)

------

## å››ã€è¿™å¼ è¡¨åé¢ä¼šæ€ä¹ˆç”¨ï¼Ÿ

åé¢ä½ ä¼šåšä¸‰ä»¶äº‹ï¼ˆå¾ˆå…³é”®ï¼‰ï¼š

1. **Python ä¸­ï¼š**
   - `check_alert()` è¿”å›å‘Šè­¦ä¿¡æ¯
2. **run_collector.pyï¼š**
   - ä¸€æ—¦æœ‰å‘Šè­¦ â†’ å†™å…¥ `alerts` è¡¨
3. **ç›‘æ§é¢æ¿ï¼ˆEChartsï¼‰ï¼š**
   - å±•ç¤ºâ€œæœ€è¿‘å‘Šè­¦è®°å½•â€

------

## âœ… ä»»åŠ¡ 2ï¼šå‡çº§ alert.pyï¼ˆæ ¸å¿ƒï¼‰

### å½“å‰çŠ¶æ€

ä½ ç°åœ¨çš„ `check_alert()` æ˜¯ï¼š

- âœ” åˆ¤æ–­æ­£ç¡®
- âŒ åªè¿”å›å­—ç¬¦ä¸²

æˆ‘ä»¬ç°åœ¨è¦è®©å®ƒ **ç›´æ¥å†™åº“**ã€‚

# ç¬¬ 1 æ­¥ï¼šæ˜ç¡®æˆ‘ä»¬è¦åšä»€ä¹ˆï¼ˆå…ˆè®²æ¸…æ¥šï¼‰

ç›®æ ‡å¾ˆç®€å•ï¼š

> **å½“ CPU / MEM / DISK è¶…è¿‡é˜ˆå€¼æ—¶ï¼ŒæŠŠå‘Šè­¦å†™å…¥ `alert_logs` è¡¨**

ä½ ç°åœ¨çš„æµç¨‹æ˜¯ï¼š

```
collect_metrics
   â†“
save_to_mysql(system_metrics)
   â†“
check_alert
   â†“
print(alert)
```

æˆ‘ä»¬è¦æ”¹æˆï¼š

```
check_alert
   â†“
save_alert_to_mysql(alert)
```

------

# ç¬¬ 2 æ­¥ï¼šç¡®è®¤ alert_logs è¡¨ï¼ˆä½ è¿™ä¸€æ­¥æ˜¯ âœ” å®Œæˆçš„ï¼‰

ä½ ç»™çš„è¡¨ç»“æ„ğŸ‘‡

```
DESC alert_logs;
id           int          auto_increment
alert_type   varchar(20)
alert_msg    varchar(255)
metric_value float
created_at   datetime DEFAULT CURRENT_TIMESTAMP
```

âœ… **å®Œå…¨æ²¡é—®é¢˜ï¼Œè®¾è®¡æ˜¯æ­£ç¡®çš„**

------

# ç¬¬ 3 æ­¥ï¼šæ–°å»ºä¸€ä¸ªæ–‡ä»¶ `save_alert.py`

ğŸ“ è·¯å¾„ï¼ˆå¾ˆé‡è¦ï¼‰ï¼š

```
monitor/collector/save_alert.py
```

### å†…å®¹å¦‚ä¸‹ï¼ˆç›´æ¥ç…§æŠ„ï¼‰

```
import pymysql

def save_alert(alert_type, alert_msg, metric_value):
    conn = pymysql.connect(
        host='localhost',
        user='monitor',
        password='monitor123',
        database='monitor_db'
    )

    cursor = conn.cursor()

    sql = """
    INSERT INTO alert_logs (alert_type, alert_msg, metric_value)
    VALUES (%s, %s, %s)
    """

    cursor.execute(sql, (alert_type, alert_msg, metric_value))
    conn.commit()

    cursor.close()
    conn.close()
```

------

# ç¬¬ 4 æ­¥ï¼šæ”¹é€  `alert.py`ï¼ˆè¿™æ˜¯å…³é”®ç‚¹ï¼‰

âš ï¸ **è¿™é‡Œéå¸¸é‡è¦ï¼šä¸è¦å†åœ¨ alert.py é‡Œ import è‡ªå·±**

### æ­£ç¡®çš„ `collector/alert.py`

```
from datetime import datetime

CPU_THRESHOLD = 3
MEM_THRESHOLD = 85
DISK_THRESHOLD = 90

def check_alert(cpu, mem, disk):
    alerts = []
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    if cpu > CPU_THRESHOLD:
        alerts.append({
            "type": "CPU",
            "msg": f"[{now}] CPU ä½¿ç”¨ç‡è¿‡é«˜: {cpu}%",
            "value": cpu
        })

    if mem > MEM_THRESHOLD:
        alerts.append({
            "type": "MEM",
            "msg": f"[{now}] å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {mem}%",
            "value": mem
        })

    if disk > DISK_THRESHOLD:
        alerts.append({
            "type": "DISK",
            "msg": f"[{now}] ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: {disk}%",
            "value": disk
        })

    return alerts
```

ğŸ“Œ **æ³¨æ„å˜åŒ–ç‚¹**

- ä¸å†è¿”å›å­—ç¬¦ä¸²
- è¿”å›çš„æ˜¯ **ç»“æ„åŒ– dictï¼ˆä¸ºå…¥åº“å‡†å¤‡ï¼‰**

------

## âœ… ä»»åŠ¡ 3ï¼šrun_collector.py æ— éœ€å¤§æ”¹

æ”¹æˆğŸ‘‡ï¼ˆå®Œæ•´ç‰ˆæœ¬ï¼‰

```
from collect_metrics import collect_metrics
from save_to_mysql import save_to_mysql
from alert import check_alert
from save_alert import save_alert

def main():
    cpu, mem, disk = collect_metrics()

    # 1. ä¿å­˜æŒ‡æ ‡
    save_to_mysql(cpu, mem, disk)

    # 2. æ£€æŸ¥å‘Šè­¦
    alerts = check_alert(cpu, mem, disk)

    # 3. å‘Šè­¦å†™å…¥æ•°æ®åº“
    for alert in alerts:
        save_alert(
            alert["type"],
            alert["msg"],
            alert["value"]
        )
        print("å‘Šè­¦å·²è®°å½•ï¼š", alert["msg"])

if __name__ == "__main__":
    main()
```

------

## ä¸‰ã€ç«‹åˆ»éªŒè¯ï¼ˆéå¸¸é‡è¦ï¼‰

### 1ï¸âƒ£ ä¿æŒ CPU_THRESHOLD = 3

### 2ï¸âƒ£ æ‰§è¡Œï¼š

```
python collector/run_collector.py
```

### 3ï¸âƒ£ ä½ åº”è¯¥çœ‹åˆ°ï¼š

```
âš  CPU ä½¿ç”¨ç‡è¿‡é«˜: 5.7%
```

![image-20251230222602050](./images/image-20251230222602050.png)

------

### 4ï¸âƒ£ æŸ¥æ•°æ®åº“ï¼ˆè¿™æ˜¯â€œå®Œæˆâ€çš„æ ‡å¿—ï¼‰

```
SELECT * FROM alert_logs ORDER BY created_at DESC;
```

å¦‚æœçœ‹åˆ°è®°å½•ï¼š

![image-20251230223005744](./images/image-20251230223005744.png)

âœ” **ä»Šå¤©çš„ä»»åŠ¡å®Œæˆ**

------

## å››ã€ä½ ç°åœ¨è¿™ä¸ªç³»ç»Ÿçš„å±‚çº§ï¼ˆéå¸¸é‡è¦ï¼‰

ä½ å·²ç»å®Œæˆäº†ï¼š

| å±‚çº§       | æ˜¯å¦å®Œæˆ |
| ---------- | -------- |
| æŒ‡æ ‡é‡‡é›†   | âœ…        |
| æ•°æ®æŒä¹…åŒ– | âœ…        |
| é˜ˆå€¼å‘Šè­¦   | âœ…        |
| å‘Šè­¦è½åº“   | âœ…        |
| å®šæ—¶è¿è¡Œ   | âœ…        |

ğŸ‘‰ **è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿ç»´ç›‘æ§å­ç³»ç»Ÿ**

# ä»»åŠ¡ 2

## ğŸ‘‰ åœ¨ Flask é¡µé¢ä¸­å±•ç¤ºå‘Šè­¦åˆ—è¡¨

------

## ä¸€ã€æˆ‘ä»¬ç°åœ¨å·²æœ‰çš„èƒ½åŠ›ï¼ˆä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼‰

ä½ ç°åœ¨å·²ç»å…·å¤‡ï¼š

- âœ… æŒ‡æ ‡é‡‡é›†ï¼ˆCPU / MEM / DISKï¼‰
- âœ… æŒ‡æ ‡å…¥åº“ï¼ˆ`system_metrics`ï¼‰
- âœ… å‘Šè­¦åˆ¤æ–­ï¼ˆ`check_alert`ï¼‰
- âœ… å‘Šè­¦å…¥åº“ï¼ˆ`alert_logs`ï¼‰
- âœ… å‰ç«¯ ECharts å±•ç¤ºæ€§èƒ½æ›²çº¿

**ç°åœ¨åªå·®ä¸€ä»¶äº‹ï¼š**

> ğŸ‘‰ æŠŠ `alert_logs` å±•ç¤ºåˆ°ç½‘é¡µä¸Š

------

## äºŒã€æ–°å¢ä¸€ä¸ªæ¥å£ï¼š`/alerts`

### 1ï¸âƒ£ æ‰“å¼€ `app.py`

ä½ ç°åœ¨å·²æœ‰ï¼š

```
@app.route("/metrics")
def metrics():
    ...
```

### 2ï¸âƒ£ åœ¨ä¸‹é¢æ–°å¢ ğŸ‘‡

```
@app.route("/alerts")
def alerts():
    conn = get_db_conn()
    cursor = conn.cursor()

    sql = """
    SELECT alert_type, alert_msg, metric_value, created_at
    FROM alert_logs
    ORDER BY created_at DESC
    LIMIT 20
    """

    cursor.execute(sql)
    data = cursor.fetchall()

    cursor.close()
    conn.close()

    return jsonify(data)
```

ğŸ“Œ è¿™ä¸ªæ¥å£ä½œç”¨ï¼š

- ä» MySQL è¯»å–æœ€è¿‘ 20 æ¡å‘Šè­¦
- è¿”å› JSONï¼Œä¾›å‰ç«¯ä½¿ç”¨

------

## ä¸‰ã€ä¿®æ”¹ `index.html`ï¼ŒåŠ ä¸€ä¸ªã€Œå‘Šè­¦åŒºåŸŸã€

### 1ï¸âƒ£ åœ¨ `<body>` é‡Œï¼ŒåŠ ä¸€ä¸ªå‘Šè­¦å®¹å™¨

æ”¾åœ¨ä½ å›¾è¡¨ä¸‹é¢å³å¯ï¼š

```
<h2>âš ï¸ å‘Šè­¦ä¿¡æ¯</h2>
<ul id="alert-list"></ul>
```

------

### 2ï¸âƒ£ åœ¨ `<script>` é‡Œï¼ŒåŠ å‘Šè­¦ JS é€»è¾‘

åœ¨ä½ ç°æœ‰çš„ `fetch("/metrics")` **åé¢**ï¼Œå†åŠ ä¸€ä¸ª ğŸ‘‡

```
<script>
/* å‘Šè­¦åˆ—è¡¨ */
fetch("/alerts")
  .then(res => res.json())
  .then(data => {
    let ul = document.getElementById("alert-list");

    if (data.length === 0) {
        ul.innerHTML = "<li>æš‚æ— å‘Šè­¦</li>";
        return;
    }

    data.forEach(a => {
        let li = document.createElement("li");
        li.innerText = `[${a.created_at}] ${a.alert_type} - ${a.alert_msg}`;
        li.style.color = "red";
        ul.appendChild(li);
    });
});
</script>
```

------

## å››ã€ç°åœ¨ä½ å¯ä»¥è¿™æ ·éªŒè¯ï¼ˆä¸€æ­¥ä¸€æ­¥æ¥ï¼‰

### âœ… 1ï¸âƒ£ å…ˆç¡®ä¿æœ‰å‘Šè­¦æ•°æ®

```
SELECT * FROM alert_logs;
```

ç¡®è®¤è¡¨é‡Œæœ‰æ•°æ®ï¼ˆä½ ä¹‹å‰å·²ç»éªŒè¯è¿‡ ğŸ‘ï¼‰

------

### âœ… 2ï¸âƒ£ç¡®è®¤ Flask æœ‰ `/alerts` æ¥å£

æµè§ˆå™¨ç›´æ¥è®¿é—®ï¼š

```
http://127.0.0.1:5000/alerts
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼ï¼š

```
[
  {
    "alert_type": "cpu",
    "alert_msg": "[2025-01-02 22:01:12] âš  CPU ä½¿ç”¨ç‡è¿‡é«˜: 12%",
    "metric_value": 12,
    "created_at": "2025-01-02 22:01:12"
  }
]
```

âŒ å¦‚æœè¿™é‡Œè®¿é—®ä¸äº† â†’ é—®é¢˜åœ¨ `app.py`
 âœ… èƒ½è®¿é—® â†’ å‰ç«¯ä¸€å®šèƒ½æ˜¾ç¤º

![image-20251230225938413](./images/image-20251230225938413.png)

------

### 3ï¸âƒ£åˆ·æ–°ä¸»é¡µ

```
http://127.0.0.1:5000/
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

- ä¸ŠåŠéƒ¨åˆ†ï¼š**çº¢è‰²å‘Šè­¦åˆ—è¡¨**

- ä¸‹åŠéƒ¨åˆ†ï¼šæ›²çº¿å›¾

  ![image-20251230230051633](./images/image-20251230230051633.png)

ç°åœ¨è¿˜è¦æ‰‹åŠ¨åˆ·æ–°ï¼Œå¾ˆéº»çƒ¦ï¼Œå°è¯•åŠ å…¥è‡ªåŠ¨åˆ·æ–°å‘Šè­¦ä¿¡æ¯

## ä¸€ã€ä½ ç°åœ¨çš„çŠ¶æ€ï¼ˆå…ˆå¯¹é½è®¤çŸ¥ï¼‰

ä½ å·²ç»æœ‰äº†ï¼š

- `/alerts` æ¥å£ âœ…
- å‘Šè­¦å†™å…¥ `alert_logs` è¡¨ âœ…
- å‰ç«¯èƒ½ fetch `/alerts` å¹¶æ˜¾ç¤ºå‘Šè­¦ï¼ˆæ‰‹åŠ¨åˆ·æ–°ï¼‰âœ…

**ç°åœ¨çš„é—®é¢˜åªæœ‰ä¸€ä¸ªï¼š**

> é¡µé¢ä¸åˆ·æ–°æ—¶ï¼Œçœ‹ä¸åˆ°â€œæ–°å‘Šè­¦â€

------

## äºŒã€å‘Šè­¦è‡ªåŠ¨åˆ·æ–°çš„æ ¸å¿ƒæ€è·¯ï¼ˆä¸€å®šè¦ç†è§£ï¼‰

è¿ç»´ç›‘æ§ç³»ç»Ÿ â‰  é¡µé¢åˆ·æ–°
 è€Œæ˜¯ï¼š

> **æµè§ˆå™¨å®šæ—¶ â†’ è¯·æ±‚æ¥å£ â†’ æ›´æ–°å±€éƒ¨ DOM**

æˆ‘ä»¬ç”¨çš„æ˜¯æœ€åŸºç¡€ã€æœ€ç¨³çš„æ–¹æ¡ˆï¼š

```
setInterval(() => {
    fetch("/alerts")
}, 10000)
```

ğŸ‘‰ **ä¸åˆ·æ–°é¡µé¢ã€ä¸é‡è½½å›¾è¡¨ï¼Œåªæ›´æ–°å‘Šè­¦åˆ—è¡¨**

------

## ä¸‰ã€ä½ ç°åœ¨è¦æ”¹çš„æ–‡ä»¶ï¼š`index.html`

### ğŸ¯ ç›®æ ‡

- é¡µé¢ä¸€æ‰“å¼€ï¼šåŠ è½½ä¸€æ¬¡å‘Šè­¦
- ä¹‹åï¼š**æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°å‘Šè­¦**

------

## å››ã€ç›´æ¥ç»™ä½ ã€Œå¯ç”¨ç‰ˆæœ¬ã€ï¼ˆæ¨èç›´æ¥æ›¿æ¢ï¼‰

åœ¨ä½ ç°æœ‰ `<script>` ä¸­ï¼ŒæŠŠ**å‘Šè­¦é‚£ä¸€æ®µ**æ”¹æˆè¿™æ · ğŸ‘‡

### âœ… å‘Šè­¦è‡ªåŠ¨åˆ·æ–°å®Œæ•´ä»£ç 

```
<script>
/* ===== å‘Šè­¦è‡ªåŠ¨åˆ·æ–° ===== */

function loadAlerts() {
    fetch("/alerts")
        .then(res => res.json())
        .then(data => {
            let ul = document.getElementById("alert-list");
            ul.innerHTML = "";

            if (data.length === 0) {
                ul.innerHTML = "<li>æš‚æ— å‘Šè­¦</li>";
                return;
            }

            data.forEach(a => {
                let li = document.createElement("li");
                li.innerText = `[${a.created_at}] ${a.alert_type.toUpperCase()} - ${a.alert_msg}`;
                li.style.color = "red";
                ul.appendChild(li);
            });
        })
        .catch(err => {
            console.error("å‘Šè­¦è·å–å¤±è´¥", err);
        });
}

/* é¡µé¢åŠ è½½ç«‹å³æ‰§è¡Œä¸€æ¬¡ */
loadAlerts();

/* æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–° */
setInterval(loadAlerts, 10000);
</script>
```

âš ï¸ **æ³¨æ„**

- è¿™æ®µä»£ç å’Œä½ åŸæ¥çš„å›¾è¡¨ JS **ä¸å†²çª**
- å¯ä»¥æ”¾åœ¨åŒä¸€ä¸ª `<script>` é‡Œï¼Œä¹Ÿå¯ä»¥åˆ†ä¸¤ä¸ª `<script>`

------

## äº”ã€ä½ ç°åœ¨è¯¥å¦‚ä½•éªŒè¯ï¼ˆæ ‡å‡†è¿ç»´éªŒè¯æµç¨‹ï¼‰

### 1ï¸âƒ£ æ‰“å¼€é¡µé¢

```
http://127.0.0.1:5000/
```

------

### 2ï¸âƒ£ å†å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œåˆ¶é€  CPU å‹åŠ›

```
yes > /dev/null &
```

ç­‰ 10ï½20 ç§’ï¼ˆCPU ä¼šæ˜æ˜¾å‡é«˜ï¼‰

------

### 3ï¸âƒ£ è§‚å¯Ÿé¡µé¢è¡Œä¸ºï¼ˆå…³é”®ï¼‰

ä½ åº”è¯¥çœ‹åˆ°ï¼š

- âŒ **æ²¡æœ‰åˆ·æ–°é¡µé¢**
- âœ… å‘Šè­¦åˆ—è¡¨ **è‡ªåŠ¨å‡ºç°æ–°å‘Šè­¦**
- âœ… æ¯ 10 ç§’æ›´æ–°ä¸€æ¬¡ï¼ˆè¿™é‡Œæœ‰ä¸€ç‚¹ï¼Œæˆ‘ä¸å¤ªè®¤åŒaiç»™å‡ºçš„è¯´æ³•ï¼Œé‡‡é›†è®¾ç½®çš„é—´éš”ä¸º1åˆ†é’Ÿï¼Œé¡µé¢è®¾ç½®10ç§’æ›´æ–°ä¸€æ¬¡åº”è¯¥æ˜¯æœ‰ç‚¹å¤ªé¢‘ç¹äº†ï¼‰

![image-20251230231152786](./images/image-20251230231152786.png)



------

### 4ï¸âƒ£ åœæ­¢å‹åŠ›æµ‹è¯•

```
killall yes
```
